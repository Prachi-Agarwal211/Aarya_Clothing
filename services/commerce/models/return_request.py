"""Return request models for commerce service."""
from datetime import datetime
from sqlalchemy import Column, Integer, String, Text, Numeric, DateTime, ForeignKey, Enum, Boolean
from sqlalchemy.orm import relationship
import enum
from database.database import Base


class ReturnReason(str, enum.Enum):
    """Return reason enumeration."""
    DEFECTIVE = "defective"
    WRONG_ITEM = "wrong_item"
    NOT_AS_DESCRIBED = "not_as_described"
    SIZE_ISSUE = "size_issue"
    COLOR_ISSUE = "color_issue"
    CHANGED_MIND = "changed_mind"
    OTHER = "other"


class ReturnStatus(str, enum.Enum):
    """Return status enumeration."""
    REQUESTED = "requested"
    APPROVED = "approved"
    REJECTED = "rejected"
    RECEIVED = "received"
    REFUNDED = "refunded"


class ReturnRequest(Base):
    """Return/refund request model."""
    __tablename__ = "return_requests"
    
    id = Column(Integer, primary_key=True, index=True)
    order_id = Column(Integer, ForeignKey("orders.id", ondelete="CASCADE"), nullable=False, index=True)
    user_id = Column(Integer, nullable=False, index=True)
    
    # Return details
    reason = Column(Enum(ReturnReason), nullable=False)
    description = Column(Text, nullable=True)
    status = Column(Enum(ReturnStatus), default=ReturnStatus.REQUESTED, nullable=False)
    
    # Financial
    refund_amount = Column(Numeric(10, 2), nullable=True)
    refund_transaction_id = Column(String(255), nullable=True)  # Links to payment service
    
    # Processing
    approved_by = Column(Integer, nullable=True)  # Staff user ID
    rejection_reason = Column(Text, nullable=True)
    
    # Return shipping
    return_tracking_number = Column(String(100), nullable=True)
    is_item_received = Column(Boolean, default=False)
    
    # Timestamps
    requested_at = Column(DateTime, default=datetime.utcnow, index=True)
    approved_at = Column(DateTime, nullable=True)
    received_at = Column(DateTime, nullable=True)
    refunded_at = Column(DateTime, nullable=True)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relationships
    order = relationship("Order", foreign_keys=[order_id])
